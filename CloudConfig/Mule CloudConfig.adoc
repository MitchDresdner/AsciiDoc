= SpringCloud config with the Mule ESB
Mitch Dresdner <MDresdner@Terathink.com>
:toc:                                             // Enable table of contents [left, right]
:toc-placement: preamble
:appversion: 1.0.0
// A link as attribute
:fedpkg: https://apps.fedoraproject.org/packages/asciidoc
// Example of other attributes
:imagesdir: ./img
:icons: font
// Default icon dir is images/icons, can override using :iconsdir: ./icons
:stylesdir: ./styles
:scriptsdir: ./js
// keywords added to html
:keywords: spring-cloud, mule, configure

[abstract]
A guide for integrating the Mule SpringCloud connector with https://cloud.spring.io/spring-cloud-config/[SpringCloud Config] configuration repository.

[.text-center]
image::SpringCloud.png[SpringCloud]

[.preamble]
// Preamble goes here


== Summary

As we start pushing out our Mule runtime instances as container based solutions into the Cloud, we look for more creative ways to bind our MicroService based solutions to potentially changing endpoint locations.

Spring Cloud configuration offers us a simple secure solution for deriving our endpoint properties at startup, through a Git repository.

When an endpoint change is needed, the change is made to the Git repository which a Mule MicroService will read at startup, without having to redeploy the service.

== Architecture

Mule supports several ways for incorporating properties, the most common approach being name/value pairs in YAML or property files.

Other approaches involve setting properties in System environment variables and passing through the -D parameter into the JVM.

[listing]
--
EXPORT resource-uri=https://resource.hots.io:8082
  or
... -Dresource-uri=https://resource.hots.io:8082
--

When SpringCloud config is used together with the Mule https://github.com/mulesoft-labs/spring-cloud-config-connector[SpringCloud Connector], allows us to abstract our properties to a Git repository where our Mule application can read and apply them at startup.


[.text-center]
image::MuleCloudConfig.png[SpringCloud Config,483,400]

NOTE: Properties imported into the Mule runtime environment from SpringCloud config will be available when transports are initialized.

== Adding the SpringCloud Connector to Mule

With the overview out of the way, lets begin the configuration of the Mule SpringCloud connector and create a demo application to show how all of the pieces fit together.

=== Configuring SpringCloud connector in your Mule app

[listing]
--
<spring-cloud-config:config name="Spring_Cloud_Config" applicationName="foo" profiles="a,b,c"
	label="abc" configServerBaseUrl="http://localhost:8888/"/>
--

== Building a standalone SpringCloud connector instance

.Start by cloning the Mule SpringCloud connector instance
* Change into the source folder
* Build and install the connector

[listing]
--
git clone https://github.com/mulesoft-labs/spring-cloud-config-connector.git
cd spring-cloud-config-connector
mvn clean install -Ddevkit.studio.package.skip=false
--

=== Import the connector into Mule

.When the build has completed you'll find a file called UpdateSite.zip in the target folder
* In AnypointStudio select Menu options: **Help->Install New Software**
* Press the **Add...**  Button
* Choose and name and the location of *UpdateSite.zip*

image::InstallConnector.png[Import MUle CloudConfig Conector]

Complete the installation of the connector.




== Creating a sample Mule project
.The Mule implementation is a simple flow consisting of the following:
* HTTP endpoint to trigger the flow
* A logger statement to display fetched property

[listing]
--
<spring-cloud-config:config name="Spring_Cloud_Config__Spring_Cloud_Configuration" applicationName="common-tecc2" profiles="dev" doc:name="Spring Cloud Config: Spring Cloud Configuration"/>

	<http:listener-config name="HTTP_Listener_Configuration" host="0.0.0.0" port="${mule.http.port}" doc:name="HTTP Listener Configuration"/>


    <flow name="mule-cloud-configFlow">
        <http:listener config-ref="HTTP_Listener_Configuration" path="/foo" doc:name="HTTP"/>
        <-- Debug to output properties -->
        <spring-cloud-config:dump-configuration config-ref="Spring_Cloud_Config__Spring_Cloud_Configuration" doc:name="Spring Cloud Config"/>

		    <logger message="Property: ActiveMQ URI = ${activemq.url}  and message = #[message]" level="INFO" doc:name="Logger"/>

    </flow>
--

With the Mule flow complete we move on to the creation of the SpringBoot component.

== Creating the SpringConfig Server

The SpringConfig Server will be a simple SpringBoot project which will look for property dependencies in a Git repository. Let's start by creating the Git repository adding a property file and commiting the changes.

.Creating the Git Repository for properties

[listing]
--
cd \home\Dev
mkdir git-localconfig-repo
cd git-localconfig-repo

# Initialize the Git repository
git init
--

.Using your favorite editor create a property file with the following sample properties:
[listing]
--
# Git Repository location is \home\Dev\git-localconfig-repo

# Use your favorite editor to create the property file below, im going to cheat and use cat in my git bash shell
cat > dev.properties
################################
#  ActimeMQ server properties  #
################################
activemq.url=tcp://localhost:61616

################################
# HTTP Properties              #
################################
mule.http.port=8083
^D
--

Now that we have a property file in a local Git repository we'll commit the changes and move on to creating the SpringConfig Server.

NOTE: All SpringBoot projects start at http://start.spring.io/

.Create a SpringBoot Project

image::SpringInitializr.png[Spring Initializer,600,300]

With the SpringConfig Server created we'll add the necessary pieces to create the server and bind to our Git properties.

.SpringConfig Server settings
* Enable the server with @EnableConfigServer
* Define the server property configuration

[listing]
--
@EnableConfigServer
@SpringBootApplication
public class SpringCloudConfigServerApplication {

	public static void main(String[] args) {
		SpringApplication.run(SpringCloudConfigServerApplication.class, args);
	}
}
--

.Property file configuration
[listing]
--
# application.properties
spring.application.name=spring-cloud-config-server
server.port=8888

# Define the location of our Git repo
spring.cloud.config.server.git.uri=file:///Home/Dev/git-localconfig-repo/
--

Now the the changes are in place for the SpringConfig Server, let's start it up and access the property settings from our Mule application

.Start our SpringConfig Server with maven
[listing]
--
mvn spring-boot:run
--

Next start the Mule flow and trigger the flow to review the results of the SpringConfig Server integration.
